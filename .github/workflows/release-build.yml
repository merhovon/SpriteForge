name: Build and Release Windows Executable

# Trigger: Wenn ein Tag gepusht wird (z.B. v1.0.0)
on:
  push:
    tags:
      - 'v*.*.*'  # Matches v1.0.0, v1.2.3, etc.

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flet pyinstaller
    
    - name: Build executable with flet pack
      run: |
        flet pack spriteforge/app.py `
          --name "SpriteForge" `
          --product-name "SpriteForge" `
          --product-version "${{ github.ref_name }}" `
          --file-description "Forge your sprites with precision" `
          --company-name "merhovon" `
          --copyright "Copyright (c) 2026 merhovon"
    
    - name: Rename executable with version
      run: |
        $version = "${{ github.ref_name }}"
        Move-Item "dist/SpriteForge.exe" "dist/SpriteForge-$version-Windows.exe"
    
    - name: Calculate SHA256
      id: hash
      run: |
        $hash = (Get-FileHash "dist/SpriteForge-${{ github.ref_name }}-Windows.exe" -Algorithm SHA256).Hash
        echo "sha256=$hash" >> $env:GITHUB_OUTPUT
        echo "SHA256: $hash"
    
    - name: Upload artifact (for debugging)
      uses: actions/upload-artifact@v4
      with:
        name: SpriteForge-Windows-Executable
        path: dist/SpriteForge-*.exe
        retention-days: 7
    
    - name: Extract Changelog for this version
      id: changelog
      run: |
        $version = "${{ github.ref_name }}"
        $versionNumber = $version -replace '^v', ''  # Remove 'v' prefix (v1.0.0 -> 1.0.0)
        $changelog = Get-Content CHANGELOG.md -Raw
        
        # Extract section for this version (matches [1.0.0])
        $pattern = "(?s)##\s*\[$versionNumber\].*?(?=##\s*\[|\z)"
        if ($changelog -match $pattern) {
          $versionChangelog = $matches[0]
          echo "Found changelog for version $versionNumber"
        } else {
          $versionChangelog = "See [CHANGELOG.md](https://github.com/merhovon/SpriteForge/blob/main/CHANGELOG.md) for details."
          echo "No specific changelog found for version $versionNumber"
        }
        
        # Add installation instructions
        $releaseNotes = @"
$versionChangelog

---

## üì¶ Windows Installation

**Standalone Executable (keine Python-Installation n√∂tig)**

**SHA256 Checksum:**
``````
${{ steps.hash.outputs.sha256 }}
``````

**System Requirements:**
- Windows 10 oder h√∂her
- Keine Python-Installation erforderlich

**Installation:**
1. Laden Sie ``SpriteForge-$version-Windows.exe`` herunter
2. Doppelklick zum Starten (Windows Defender SmartScreen ggf. best√§tigen)

**Alternative Installation via pip:**
``````bash
pip install spriteforge==$versionNumber
``````
"@
        
        # Save to file
        $releaseNotes | Out-File -FilePath changelog_section.txt -Encoding utf8
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: dist/SpriteForge-*.exe
        body_path: changelog_section.txt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Notify on failure
      if: failure()
      run: |
        echo "::error::Build failed! Check the logs above."
