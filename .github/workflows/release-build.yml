name: Build and Release Windows Executable

# Trigger: Wenn ein Release erstellt wird
on:
  release:
    types: [published]
  # Optional: Manueller Trigger f√ºr Tests
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flet pyinstaller
    
    - name: Build executable with flet pack
      run: |
        flet pack spriteforge/app.py `
          --name "SpriteForge" `
          --product-name "SpriteForge" `
          --product-version "${{ github.event.release.tag_name }}" `
          --file-description "Forge your sprites with precision" `
          --company-name "merhovon" `
          --copyright "Copyright (c) 2026 merhovon"
    
    - name: Rename executable with version
      run: |
        $version = "${{ github.event.release.tag_name }}"
        Move-Item "dist/SpriteForge.exe" "dist/SpriteForge-$version-Windows.exe"
    
    - name: Calculate SHA256
      id: hash
      run: |
        $hash = (Get-FileHash "dist/SpriteForge-${{ github.event.release.tag_name }}-Windows.exe" -Algorithm SHA256).Hash
        echo "sha256=$hash" >> $env:GITHUB_OUTPUT
        echo "SHA256: $hash"
    
    - name: Upload artifact (for debugging)
      uses: actions/upload-artifact@v4
      with:
        name: SpriteForge-Windows-Executable
        path: dist/SpriteForge-*.exe
        retention-days: 7
    
    - name: Upload to Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/SpriteForge-*.exe
        body: |
          ## Windows Executable
          
          üì¶ **Standalone Executable (keine Python-Installation n√∂tig)**
          
          **SHA256 Checksum:**
          ```
          ${{ steps.hash.outputs.sha256 }}
          ```
          
          **System Requirements:**
          - Windows 10 oder h√∂her
          - Keine Python-Installation erforderlich
          
          **Installation:**
          1. Laden Sie `SpriteForge-${{ github.event.release.tag_name }}-Windows.exe` herunter
          2. Doppelklick zum Starten (Windows Defender SmartScreen ggf. best√§tigen)
          
          **Alternative Installation via pip:**
          ```bash
          pip install spriteforge==${{ github.event.release.tag_name }}
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Notify on failure
      if: failure()
      run: |
        echo "::error::Build failed! Check the logs above."

  # Optional: Linux Build
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flet pyinstaller
    
    - name: Build executable with flet pack
      run: |
        flet pack spriteforge/app.py \
          --name "SpriteForge" \
          --product-name "SpriteForge" \
          --product-version "${{ github.event.release.tag_name }}"
    
    - name: Rename and compress
      run: |
        mv dist/SpriteForge dist/spriteforge
        tar -czvf dist/SpriteForge-${{ github.event.release.tag_name }}-Linux.tar.gz -C dist spriteforge
    
    - name: Upload to Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/SpriteForge-*.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Optional: macOS Build
  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flet pyinstaller
    
    - name: Build app bundle with flet pack
      run: |
        flet pack spriteforge/app.py \
          --name "SpriteForge" \
          --product-name "SpriteForge" \
          --product-version "${{ github.event.release.tag_name }}"
    
    - name: Create DMG (optional)
      run: |
        # Erstelle ein einfaches DMG aus dem .app bundle
        hdiutil create -volname SpriteForge -srcfolder dist/SpriteForge.app -ov -format UDZO dist/SpriteForge-${{ github.event.release.tag_name }}-macOS.dmg
    
    - name: Upload to Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/SpriteForge-*.dmg
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
