name: Build and Release Windows Executable

# Trigger: Wenn ein Tag gepusht wird (z.B. v1.0.0)
on:
  push:
    tags:
      - 'v*.*.*'  # Matches v1.0.0, v1.2.3, etc.

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flet pyinstaller
    
    - name: Build executable with flet pack
      run: |
        flet pack spriteforge/app.py `
          --name "SpriteForge" `
          --product-name "SpriteForge" `
          --product-version "${{ github.ref_name }}" `
          --file-description "Forge your sprites with precision" `
          --company-name "merhovon" `
          --copyright "Copyright (c) 2026 merhovon"
    
    - name: Rename executable with version
      run: |
        $version = "${{ github.ref_name }}"
        Move-Item "dist/SpriteForge.exe" "dist/SpriteForge-$version-Windows.exe"
    
    - name: Calculate SHA256
      id: hash
      run: |
        $hash = (Get-FileHash "dist/SpriteForge-${{ github.ref_name }}-Windows.exe" -Algorithm SHA256).Hash
        echo "sha256=$hash" >> $env:GITHUB_OUTPUT
        echo "SHA256: $hash"
    
    - name: Upload artifact (for debugging)
      uses: actions/upload-artifact@v4
      with:
        name: SpriteForge-Windows-Executable
        path: dist/SpriteForge-*.exe
        retention-days: 7
    
    - name: Extract Changelog for this version
      id: changelog
      run: |
        $version = "${{ github.ref_name }}"
        $versionNumber = $version -replace '^v', ''
        $changelog = Get-Content CHANGELOG.md -Raw
        
        # Extract section for this version (matches [1.0.0])
        $pattern = "(?s)##\s*\[$versionNumber\].*?(?=##\s*\[|\z)"
        if ($changelog -match $pattern) {
          $versionChangelog = $matches[0]
          echo "Found changelog for version $versionNumber"
        } else {
          $versionChangelog = "See [CHANGELOG.md](https://github.com/merhovon/SpriteForge/blob/main/CHANGELOG.md) for details."
          echo "No specific changelog found for version $versionNumber"
        }
        
        # Create release notes file
        $versionChangelog | Out-File -FilePath changelog_section.txt -Encoding utf8
        
        # Add separator and installation instructions
        "" | Out-File -FilePath changelog_section.txt -Append -Encoding utf8
        "---" | Out-File -FilePath changelog_section.txt -Append -Encoding utf8
        "" | Out-File -FilePath changelog_section.txt -Append -Encoding utf8
        "## üì¶ Windows Installation" | Out-File -FilePath changelog_section.txt -Append -Encoding utf8
        "" | Out-File -FilePath changelog_section.txt -Append -Encoding utf8
        "**Standalone Executable (keine Python-Installation n√∂tig)**" | Out-File -FilePath changelog_section.txt -Append -Encoding utf8
        "" | Out-File -FilePath changelog_section.txt -Append -Encoding utf8
        "**SHA256 Checksum:**" | Out-File -FilePath changelog_section.txt -Append -Encoding utf8
        '```' | Out-File -FilePath changelog_section.txt -Append -Encoding utf8
        "${{ steps.hash.outputs.sha256 }}" | Out-File -FilePath changelog_section.txt -Append -Encoding utf8
        '```' | Out-File -FilePath changelog_section.txt -Append -Encoding utf8
        "" | Out-File -FilePath changelog_section.txt -Append -Encoding utf8
        "**System Requirements:**" | Out-File -FilePath changelog_section.txt -Append -Encoding utf8
        "- Windows 10 oder h√∂her" | Out-File -FilePath changelog_section.txt -Append -Encoding utf8
        "- Keine Python-Installation erforderlich" | Out-File -FilePath changelog_section.txt -Append -Encoding utf8
        "" | Out-File -FilePath changelog_section.txt -Append -Encoding utf8
        "**Installation:**" | Out-File -FilePath changelog_section.txt -Append -Encoding utf8
        "1. Laden Sie ``SpriteForge-$version-Windows.exe`` herunter" | Out-File -FilePath changelog_section.txt -Append -Encoding utf8
        "2. Doppelklick zum Starten (Windows Defender SmartScreen ggf. best√§tigen)" | Out-File -FilePath changelog_section.txt -Append -Encoding utf8
        "" | Out-File -FilePath changelog_section.txt -Append -Encoding utf8
        "**Alternative Installation via pip:**" | Out-File -FilePath changelog_section.txt -Append -Encoding utf8
        '```bash' | Out-File -FilePath changelog_section.txt -Append -Encoding utf8
        "pip install spriteforge==$versionNumber" | Out-File -FilePath changelog_section.txt -Append -Encoding utf8
        '```' | Out-File -FilePath changelog_section.txt -Append -Encoding utf8
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: dist/SpriteForge-*.exe
        body_path: changelog_section.txt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Notify on failure
      if: failure()
      run: |
        echo "::error::Build failed! Check the logs above."
